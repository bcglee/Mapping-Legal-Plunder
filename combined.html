<!DOCTYPE html>
<html lang="en">

<style>
    .bar rect {
        fill: steelblue;
    }

    .bar text {
        fill: #fff;
        font: 10px sans-serif;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        width: 200px;
        height: 15px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    /* //https://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218 */
    .grid line {
      stroke: lightgrey;
      stroke-opacity: 0.7;
      shape-rendering: crispEdges;
    }
</style>

<head>
    <meta charset="utf-8">
    <title>Lucca Debt</title>
    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
</head>
<!-- <body> -->
<div id="reset">
    <input name="reset" type="button" value="Reset Zoom" onclick="resetzoom()" />
</div>
<svg width="1000" height="450"></svg>
<script type="text/javascript">
    var width = 1000;
    var height = 400;

    // define map projections
    var initial_projection = d3.geoAlbers() // zoomed out overview of Italy
        .center([0, 42])
        .rotate([347, 0])
        .parallels([35, 45])
        .scale(2750)
        .translate([width / 2, height / 2]);

    var true_projection = d3.geoAlbers() // zoomed in on Lucca
        .center([-2, 44])
        .rotate([347.5, 0.125])
        .parallels([35, 45])
        .scale(50000)
        .translate([width / 2, height / 2]);

    // define path generators
    var initial_path = d3.geoPath()
        .projection(initial_projection);

    var true_path = d3.geoPath()
        .projection(true_projection);

    // create svg element
    var svg = d3.select("svg"),
        margin = { right: 50, left: 50 },
        width = +svg.attr("width") - margin.left - margin.right
    height = +svg.attr("height");

    var curr_transform;

    // defines the zoom function
    var zoom = d3.zoom()   //https://bl.ocks.org/iamkevinv/0a24e9126cd2fa6b283c6f2d774b69a2
        .scaleExtent([1, 8])
        .translateExtent([[0, 0], [width + margin.left + margin.right, height]])
        .on("zoom", zoomed);

    // sets dot size for plotting
    var dot_size = 2

    // calls the zoom function
    svg.call(zoom);

    // state variable, to be changed by dropdown (future slider)
    var state = ({ year: "1333" });

    // transition duration in ms for zoom on load
    load_transition_duration = 2500;
    // transition delay in ms for zoom on load
    load_transition_delay = 1500;

    // http://bl.ocks.org/biovisualize/1016860
    // https://bl.ocks.org/alandunning/274bf248fd0f362d64674920e85c1eb7
    var tooltip = d3.select("body")
      .append("div")
      .attr("class", "tooltip")  // from http://bl.ocks.org/d3noob/a22c42db65eb00d4e369
      .style("position", "absolute")
      .style("z-index", "10")
      .style("visibility", "hidden");

    // initial plottng of gray points for zoom
    d3.json("https://homes.cs.washington.edu/~akintilo/cse512/a3/italy.json").then(function (map) {
        d3.csv("data/unique_locations.csv").then(function (data) {
            // show map
            svg.selectAll("path")
                .data(topojson.feature(map, map.objects.custom).features)
                .join("path")
                .attr("fill", "#3d3d3d")
                .attr("d", initial_path);

            // show dots
            dots = svg.selectAll(".backdot").data(data) // selection should be empty...
            enterdots = dots.enter()
                .append("circle")
                .attr("class", "backdot")
                .attr("cx", function (d) {
                    return initial_projection([d["lon"], d["lat"]])[0];
                })
                .attr("cy", function (d) {
                    return initial_projection([d["lon"], d["lat"]])[1];
                })
                .attr("r", function(d) {
                    // return Math.log(d["ct"]+1);
                    return Math.sqrt(d["ct"]/2);
                })
                .attr("fill","gray")
                .attr("fill-opacity", .75)
                .on("mouseover", function(d){return tooltip.style("visibility", "visible")
                                                           .text(d["town"]);})
                //.on("mouseover", function(d){return tooltip.text("TEST");})
              	.on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
              	.on("mouseout", function(){return tooltip.style("visibility", "hidden");});



            // zoom in on load
            svg.selectAll("path")
                .data(topojson.feature(map, map.objects.custom).features)
                .join("path")
                .transition("map_zoom") // ugly transition, ease-in-out would be better
                .delay(load_transition_delay)
                .duration(load_transition_duration)
                .attr("d", true_path);

            enterdots.transition("dot_zoom")
                .delay(load_transition_delay)
                .duration(load_transition_duration)
                .attr("cx", function (d) {
                    return true_projection([d["lon"], d["lat"]])[0];
                })
                .attr("cy", function (d) {
                    return true_projection([d["lon"], d["lat"]])[1];
                });
        });
    });

    // adds blue background in order to make water blue
    svg.append('rect')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height)
        .attr('fill', 'lightBlue');

    // PUTTING THE TIMELINE HISTOGRAM HERE!!!!!!!
    //USED THIS WEBSITE:  https://bl.ocks.org/EmbraceLife/eed2f62f855854739ddf5e572d4322ed

    var parseDate = d3.isoParse,
        formatCount = d3.format(",.0f");

    var margin2 = { top: 30, right: 30, bottom: 30, left: 30 },
        width2 = 1000 - margin2.left - margin2.right,
        height2 = 250 - margin2.top - margin2.bottom;

    var svg2 = d3.select("body").append("svg")
        .attr("class", "time_hist")
        .attr("width", width2 + margin2.left + margin2.right)
        .attr("height", height2 + margin2.top + margin2.bottom)
        .append("g")
        .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");


    // ---- date data scale-map to px --------------------------
    //   1. assign xScale a scaleTime func
    var xScale = d3.scaleTime()
        //   2. set input or date range
        .domain([new Date(1332, 10, 1), new Date(1343, 2, 1)])
        //   3. set output or px range
        .rangeRound([0, width2]);

    var xTickNum = 20;

    var yScale = d3.scaleLinear()
        .range([height2, 0]);

    var histogram = d3.histogram()

        // histogram func only use date value from each row of dataset
        // .value() is like a row function to d3.histogram()
        // as .row() to d3.tsv()
        .value(function (d) { return d.date_full; })
        .domain(xScale.domain())
        .thresholds(xScale.ticks(d3.timeMonth)); //note error with xScale(x1) in rect!!

    //from this:  https://stackoverflow.com/questions/40173533/customize-the-d3-month-or-year-tick-format
    var xAxis = d3.axisBottom(xScale)
                  .tickFormat("")
                  .ticks(xTickNum);

    svg2.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height2 + ")")
        .call(xAxis)
        .selectAll(".tick text")
        .style("text-anchor", "start")
        .attr("x", 6)
        .attr("y", 6);

    // https://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218
    svg2.append("g")
        .attr("class", "grid")
        .attr("transform", "translate(0," + height2 + ")")
        .call(make_x_gridlines()
              .tickSize(-height2)
              .tickFormat(d3.timeFormat("%Y")))
        .selectAll("text")
        .attr("dy", "1.25em");

        // https://bl.ocks.org/d3noob/0e276dc70bb9184727ee47d6dd06e915
        // .selectAll("text")
        //         .style("text-anchor", "end")
        //         .attr("dx", "-.8em")
        //         .attr("dy", ".15em")
        //         .attr("transform", "rotate(-65)");

   var yAxis = d3.axisLeft(yScale)

   // sets yScale
   // yScale.domain([0, d3.max(bins, function (d) { return d.length; })]); // can only set the domain of y scaling function once the data has been loaded
   yScale.domain([0, 300])

   // adds axis to svg2
   svg2.append("g")
       .call(yAxis);

    // add the Y gridlines
    svg2.append("g")
        .attr("class", "grid")
        .call(make_y_gridlines()
             .tickSize(-width2)
             .tickFormat("")
           );

    //adds title to timeline
    svg2.append("text")
        .attr("x", (width2 / 2))
        .attr("y", 10 - (margin2.top / 2))
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        .style("text-decoration", "underline")
        .text("TIMELINE OF PLUNDER");


    // set the dimensions and margins of the graph
    var margin3 = {top: 20, right: 20, bottom: 100, left: 40},
        width3 = 1000 - margin3.left - margin3.right,
        height3 = 300 - margin3.top - margin3.bottom;

    // set the ranges
    var x = d3.scaleBand()
              .range([0, width3])
              .padding(0.1);
    var y = d3.scaleLinear()
              .range([height3, 0]);

    // append the svg object to the body of the page
    // append a 'group' element to 'svg'
    // moves the 'group' element to the top left margin
    var svg3 = d3.select("body").append("svg")
                  .attr("width", width3 + margin3.left + margin3.right)
                  .attr("height", height3 + margin3.top + margin3.bottom)
                  .append("g")
                  .attr("transform",
                  "translate(" + margin3.left + "," + margin3.top + ")");

    //adds title to timeline
    svg3.append("text")
        .attr("x", (width3 / 2))
        .attr("y", 10 - (margin3.top / 2))
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        .style("text-decoration", "underline")
        .text("PLUNDERED ITEM CATEGORIES");


    // apply date format func to date value of each row of data
    // necessary for data read of lucca_debt_full_dates_cleaned.csv
    function type(d) {
        d.date_full = parseDate(d.date_full);
        return d;
    }

    d3.csv("data/DALME_datasets/lucca_debt_full_dates_cleaned.csv", type).then(function (data) {
        d3.csv("data/unique_locations.csv").then(function (locations) {

        // ---- apply data to histogram func -------------
        // meaning: regroup all data into different bins
        var bins = histogram(data);

        var bar = svg2.selectAll(".bar")
            .data(bins)
            .enter().append("g")
            .attr("class", "bar")
            .attr("transform", function (d) { return "translate(" + xScale(d.x0) + "," + yScale(d.length) + ")"; })
            ;

        var rects = bar.append("rect")
            .attr("x", 1)
            .attr("width", function (d) { return xScale(d.x1) - xScale(d.x0) - 1; })
            .attr("height", function (d) { return height2 - yScale(d.length); });

        //https://bl.ocks.org/Fil/2d43867ba1f36a05459c7113c7f6f98a
        var brush = d3.brushX()
            .extent([[0, 0], [width2, height2]])
            .on("start brush end", brushmoved);
        var gBrush = svg2.append("g")
            .attr("class", "brush")
            .call(brush);
        var brushResizePath = function (d) {
            var e = +(d.type == "e"),
                x = e ? 1 : -1,
                y = height2 / 2;
            return "M" + (.5 * x) + "," + y + "A6,6 0 0 " + e + " " + (6.5 * x) + "," + (y + 6) + "V" + (2 * y - 6) + "A6,6 0 0 " + e + " " + (.5 * x) + "," + (2 * y) + "Z" + "M" + (2.5 * x) + "," + (y + 8) + "V" + (2 * y - 8) + "M" + (4.5 * x) + "," + (y + 8) + "V" + (2 * y - 8);
        }
        var handle = gBrush.selectAll(".handle--custom")
            .data([{ type: "w" }, { type: "e" }])
            .enter().append("path")
            .attr("class", "handle--custom")
            .attr("stroke", "#000")
            .attr("cursor", "ew-resize")
            .attr("d", brushResizePath);

        gBrush.call(brush.move, [0.3, 0.5].map(xScale));

        function brushmoved() {
            var selection = d3.event.selection;
            if (selection == null) {
                handle.attr("display", "none");
                //circle.classed("active", false);
            } else {
                var e = d3.event.selection.map(xScale.invert, xScale);
                var newData = data.filter(function (d) {return e[0] <= d.date_full && e[1] >= d.date_full; });
                d3.selectAll('.foredot').remove(); // remove old foredots

                svg.selectAll('.foredot')
                    .data(locations)
                    .enter()
                    .append("circle")
                    .attr("class", "foredot")
                    .attr("cx", function (d) {
                        return true_projection([d["lon"], d["lat"]])[0];
                    })
                    .attr("cy", function (d) {
                        return true_projection([d["lon"], d["lat"]])[1];
                    })
                    .attr("transform", curr_transform)
                    .attr("r", function(d) {
                        return Math.sqrt(newData.filter(el => el["town"] === d["town"]).length/2);
                    })
                    .style("fill", "green")
                    .on("mouseover", function(d){return tooltip.style("visibility", "visible")
                                                               .text(d["town"]);})
                    //.on("mouseover", function(d){return tooltip.text("TEST");})
                  	.on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
                  	.on("mouseout", function(){return tooltip.style("visibility", "hidden");});

                handle.attr("display", null).attr("transform", function (d, i) { return "translate(" + [selection[i], - height2 / 4] + ")"; });
                d3.selectAll('.forebar').remove(); 
                svg3.selectAll(".forebar")
            .data(newData)
            .enter().append("rect")
            .attr("class", "forebar")
            .attr("x", function(d) { return x(d.object_category); })
            .attr("width", x.bandwidth())
            .style("fill", "green")
            .attr("y", function(d) { return y(newData.filter(el => el["object_category"] === d["object_category"]).length) })
            .attr("height", function(d) { return height3 -y(newData.filter(el => el["object_category"] === d["object_category"]).length); });
            }
        }

        // Scale the range of the data in the domains
        x.domain(data.map(function(d) { return d.object_category; }));
        y.domain([0, 2000]);

        // append the rectangles for the bar chart
        svg3.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(d.object_category); })
            .attr("width", x.bandwidth())
            .attr("y", function(d) { return y(data.filter(el => el["object_category"] === d["object_category"]).length) })
            .attr("height", function(d) { return height3 -y(data.filter(el => el["object_category"] === d["object_category"]).length); });

        // add the x Axis
        svg3.append("g")
            .attr("transform", "translate(0," + height3 + ")")
            .call(d3.axisBottom(x));

        // add the y Axis
        svg3.append("g")
            .call(d3.axisLeft(y));

      	// rotates x-axis labels
      	// https://bl.ocks.org/d3noob/0e276dc70bb9184727ee47d6dd06e915
      	svg3.selectAll("text")
            //.call(xAxis)
      	   .style("text-anchor", "end")
      		 .attr("dx", "-.8em")
      		 .attr("dy", ".15em")
      		 .attr("transform", "rotate(-45)");


      })
    });

    /* *** FUNCTIONS *** */

    //reset button for resetting zoom
    function resetzoom() {
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
    };

    // TODO: maybe use a different transition (fade out/in?) to avoid
    // misleading users into tinking shrinking is meaningful
    function update(year, data) {
        state.year = year;
        var newData = data.filter(row => isYear(row, state.year) && hasLocation(row));
        var duration = 750; // (total transition time)/2

        // make all dots disappear
        svg.selectAll(".backdot")
            // transition.remove() requires elements have no pending transitions,
            // so we change its class
            .attr("class", "old_dot")
            .transition("leave")
            .remove()
            .duration(duration)
            .style("opacity", 0)
            .attr("r", 0);

        dots = svg.selectAll(".backdot").data(newData)

        // create (invisible) points for enter()
        dots.enter()
            .append("circle")
            .attr("class", "backdot")
            .attr("cx", function (d) {
                return true_projection([d["lon"], d["lat"]])[0];
            })
            .attr("cy", function (d) {
                return true_projection([d["lon"], d["lat"]])[1];
            })
            .attr("transform", curr_transform)
            .attr("fill", "red")
            .style("opacity", 0)
            .attr("r", 0);

        // fade (unshrink?) points in
        svg.selectAll(".backdot")
            .transition("enter")
            .duration(duration)
            .delay(duration)
            .style("opacity", 1)
            .attr("r", dot_size);
    }

    function isYear(row, year) {
        return row.date_year === year;
    }

    function hasLocation(row) {
        return row.lat !== '';
    }

    // function for zooming
    function zoomed() {
        curr_transform = d3.event.transform;
        //transforms the map appropriately (with zoom)
        svg.selectAll('path')
            .attr('transform', d3.event.transform);

        //transforms the dots appropriately (with zoom)
        svg.selectAll(".backdot")
            .attr('transform', d3.event.transform);

        //transforms the dots appropriately (with zoom)
        svg.selectAll(".foredot")
            .attr('transform', d3.event.transform);
    };

    // gridlines in x axis function https://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218
    function make_x_gridlines() {
        return d3.axisBottom(xScale)
                 .ticks(xTickNum)
        }

    // gridlines in y axis function https://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218
    function make_y_gridlines() {
        return d3.axisLeft(yScale)
                 .ticks(10)
        }

</script>
<!-- </body> -->

</html>
